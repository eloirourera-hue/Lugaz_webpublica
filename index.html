<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lugaz - Comparador de Luz</title>
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    </head>
<body>
<div class="card">
    <h1>Lugaz</h1>
    <p style="text-align:center;font-size:1.4rem;margin-bottom:30px">Sube tu factura **solo en formato PDF**</p>
    
    <input type="email" id="email" placeholder="Tu email" required>
    <input type="file" id="factura" accept=".pdf">
    <button onclick="procesar()">¬°Calcular ahorro!</button>
    
    <div id="estado">Aseg√∫rate de tener el servidor Python abierto</div>
    <div id="datos-extraidos" style="display: none;"></div>

    <div class="manual" id="manual">
        <p>‚ö†Ô∏è Error al procesar tu factura. Rellena los datos manualmente:</p>
        <input type="number" id="consumo" placeholder="Consumo kWh/mes (ej: 320)" required>
        <input type="number" step="0.01" id="potencia" placeholder="Potencia contratada kW (ej: 5.75)" required>
        <input type="number" step="0.01" id="gasto" placeholder="Gasto actual ‚Ç¨/mes (ej: 78.45)" required>
        <button onclick="enviarDatosManual()">Calcular Manualmente</button>
    </div>

    <div id="resultado" class="resultado"></div>
</div>

<script>
    // URL de tu Python Local (Usado solo para la prueba local y para simular el fallo en web p√∫blica)
    const PYTHON_BACKEND_URL = "http://127.0.0.1:5000/analizar"; 
    // URL de tu Google Sheet (VERIFICADA)
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyv5MchGwmmU2pG2hUJTVSRXOnbTSVHbExptdNWkTMUx58YTZylo2WkDP2M6wGojJdK/exec";

    // --- DATOS FICTICIOS PARA EL C√ÅLCULO MANUAL (Deben coincidir con tu app.py) ---
    const tarifas = [
        { empresa: "Endesa", nombre: "Permanencia 12 meses", kwh: 0.108, pot_punta: 0.122, pot_valle: 0.052, descuento: 28 },
        { empresa: "Iberdrola", nombre: "Sin permanencia", kwh: 0.112, pot_punta: 0.124, pot_valle: 0.054, descuento: 22 },
        { empresa: "Eleia", nombre: "Permanencia 12 meses", kwh: 0.115, pot_punta: 0.130, pot_valle: 0.045, descuento: 35 },
        { empresa: "Plenitude", nombre: "Sin permanencia", kwh: 0.104, pot_punta: 0.118, pot_valle: 0.050, descuento: 20 }
    ];

    // --- FUNCI√ìN DE UTILIDAD PARA LEER LA URL ---
    function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // --- C√ìDIGO DE INICIO ---
    document.addEventListener('DOMContentLoaded', () => {
        const email = getParameterByName('email');
        const emailInput = document.getElementById('email');

        if (email) {
            emailInput.value = email;
            emailInput.readOnly = true; 
            emailInput.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
        } else {
            // Si llegan sin email, los devolvemos al formulario inicial (lead.html)
            window.location.href = 'lead.html'; 
        }
    });

    // --- 1. PROCESAR PDF (Intento de conexi√≥n a Python / Falla en web p√∫blica) ---
    async function procesar() {
        const email = document.getElementById("email").value.trim();
        const file = document.getElementById("factura").files[0];
        const estado = document.getElementById("estado");

        if (!file) { estado.textContent = "Sube el PDF de tu factura."; return; }
        if (file.type !== "application/pdf") { estado.textContent = "‚ùå ERROR: Debes subir un archivo en formato PDF."; return; }

        estado.textContent = "Intentando calcular autom√°ticamente...";
        
        // üí° ESTA SECCI√ìN FALLAR√Å EN LA WEB P√öBLICA (USANDO GITHUB PAGES)
        try {
            const formData = new FormData();
            formData.append('email', email);
            formData.append('factura', file);
            
            // Intentamos la conexi√≥n al backend de Python (solo funcionar√° en tu PC)
            const response = await fetch(PYTHON_BACKEND_URL, { method: 'POST', body: formData });
            const data = await response.json();
            
            if (data.status === 'success') { 
                estado.textContent = "‚úÖ Comparativa finalizada.";
                // Si funciona, usa los datos reales devueltos por Python
                mostrarResultados(data.consumo, data.potencia, data.gastoActual, data.tarifas); 
                return; 
            }

        } catch (e) {
            // üí° RUTA DE FALLO: El servidor Python no est√° activo o es inaccesible
            estado.textContent = "‚ö†Ô∏è Error de conexi√≥n/c√°lculo. Rellena los datos manualmente.";
            document.getElementById("manual").style.display = "block";
            console.error("Fallo de conexi√≥n al backend de Python:", e);
        }
    }
    
    // --- 2. ENVIAR DATOS MANUALES (C√°lculo sin servidor Python) ---
    function enviarDatosManual() {
        const consumo = parseFloat(document.getElementById("consumo").value);
        const potencia = parseFloat(document.getElementById("potencia").value);
        const gasto = parseFloat(document.getElementById("gasto").value);
        const estado = document.getElementById("estado");

        if (isNaN(consumo) || isNaN(potencia) || isNaN(gasto)) {
            estado.textContent = "Rellena los 3 campos de datos manuales.";
            return;
        }

        document.getElementById("manual").style.display = "none";
        estado.textContent = "‚úÖ Calculando con datos manuales. Resultados a continuaci√≥n.";
        
        // Usa los datos introducidos por el usuario y las tarifas fijas del JS
        mostrarResultados(consumo, potencia, gasto, tarifas); 
    }

    // --- 3. MOSTRAR RESULTADOS (Funci√≥n de c√°lculo y renderizado) ---
    function mostrarResultados(consumoGlobal, potenciaGlobal, gastoActualGlobal, tarifasDisponibles) {
        const resultado = document.getElementById("resultado");
        const datosExtraidos = document.getElementById("datos-extraidos");
        const dias = 30.41; // Media de d√≠as por mes
        const alquilerGlobal = 0.81; // Coste fijo estimado de alquiler de contador
        let html = '<h2 class="resultado-title">¬°Tus mejores ofertas!</h2>';
        
        // Mostrar datos usados
        datosExtraidos.innerHTML = `Datos usados: **Consumo:** ${consumoGlobal} kWh/mes ¬∑ **Potencia:** ${potenciaGlobal} kW ¬∑ **Gasto Actual:** ${gastoActualGlobal.toFixed(2)}‚Ç¨/mes`;
        datosExtraidos.style.display = "block";

        tarifasDisponibles.forEach(t => {
            // C√ÅLCULOS ESTANDARIZADOS 
            const energia = consumoGlobal * t.kwh;
            const potenciaCoste = (potenciaGlobal * t.pot_punta * dias) + (potenciaGlobal * t.pot_valle * dias);
            const base = energia + potenciaCoste;
            const impuesto = base * 0.05113; // Impuesto de electricidad
            const baseIVA = base + impuesto + alquilerGlobal; // + Alquiler de contador
            const iva = baseIVA * 0.21;
            const totalSinDesc = baseIVA + iva;
            
            // Aplicar descuento
            const totalConDesc = totalSinDesc * (1 - t.descuento / 100);
            
            // C√°lculo de ahorro
            const ahorroMensual = gastoActualGlobal - totalConDesc;
            const ahorroAnual = Math.round(ahorroMensual * 12);
            
            const claseAhorro = ahorroAnual > 0 ? 'positivo' : 'negativo';
            const simboloAhorro = ahorroAnual > 0 ? '¬°Ahorras' : '¬°Gastas m√°s';
            const textoAhorro = `${simboloAhorro} ${Math.abs(ahorroAnual)}‚Ç¨ al a√±o!`;

            html += `
                <div class="tarifa">
                    <div class="empresa">${t.empresa}</div>
                    <div style="color:#94a3b8;margin:8px 0">${t.nombre}</div>
                    <div class="precio">${totalConDesc.toFixed(0)}‚Ç¨/mes</div>
                    <div class="ahorro ${claseAhorro}">${textoAhorro}</div>
                    <div style="margin-top:10px;color:#94a3b8;font-size:0.9rem">-${t.descuento}% primer a√±o</div>
                </div>
            `;
        });

        resultado.innerHTML = html;
        resultado.style.display = "grid";
    }
</script>
</body>
</html>