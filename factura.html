<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lugaz - Comparador de Luz</title>
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        /* Estilos en línea para compatibilidad */
        body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#0f172a,#1e40af,#0ea5e9);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(15px);border-radius:24px;padding:40px;max-width:500px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,0.4)}
        h1{font-size:3.5rem;text-align:center;background:linear-gradient(to right,#60a5fa,#a5f3fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        input,button{width:100%;padding:16px;margin:12px 0;border:none;border-radius:12px;font-size:1.1rem}
        input{background:rgba(255,255,255,0.15);color:#fff}
        input::placeholder{color:#cbd5e1}
        button{background:#0ea5e9;color:#fff;cursor:pointer;font-size:1.3rem}
        button:hover{background:#0c8bd4}
        #estado{margin-top:15px;color:#fbbf24;font-weight:600;text-align:center}
        .manual{display:none;background:rgba(255,255,255,0.1);padding:20px;border-radius:16px;margin-top:20px}
        .resultado{display:none;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-top:40px}
        .tarifa{background:rgba(255,255,255,0.1);padding:25px;border-radius:16px;text-align:center;transition:0.3s}
        .tarifa:hover{transform:translateY(-10px);box-shadow:0 20px 40px rgba(0,0,0,0.4)}
        .empresa{font-size:1.9rem;font-weight:700}
        .precio{font-size:3rem;color:#34d399;margin:10px 0}
        .ahorro{font-size:1.3rem;color:#fbbf24}
    </style>
</head>
<body>
<div class="card">
    <h1>Lugaz</h1>
    <p style="text-align:center;font-size:1.4rem;margin-bottom:30px">Sube tu factura o pon los datos manualmente</p>
    
    <input type="email" id="email" placeholder="Tu email" required>
    <input type="file" id="factura" accept=".pdf,.jpg,.jpeg,.png">
    <button onclick="procesar()">¡Calcular ahorro!</button>
    <div id="estado">Sube tu factura o usa modo manual ↓</div>

    <div class="manual" id="manual">
        <p>Modo manual (si la factura no se lee bien):</p>
        <input type="number" id="consumo" placeholder="Consumo kWh (ej: 320)">
        <input type="number" step="0.01" id="potencia" placeholder="Potencia contratada kW (ej: 5.75)" value="5.75">
        <input type="number" step="0.01" id="gasto" placeholder="Gasto actual € (ej: 78.45)">
        <button onclick="calcularManual()">Calcular</button>
    </div>

    <div id="resultado" class="resultado"></div>
</div>

<script>
    // URL de tu Python Local (solo para pruebas locales)
    const PYTHON_BACKEND_URL = "http://127.0.0.1:5000/analizar"; 
    // URL de tu Google Sheet (VERIFICADA Y CORREGIDA)
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyv5MchGwmmU2pG2hUJTVSRXOnbTSVHbExptdNWkTMUx58YTZylo2WkDP2M6wGojJdK/exec";

    // --- DATOS FICTICIOS PARA EL CÁLCULO MANUAL (Los que tenías en tu código) ---
    const tarifas = [
        { empresa: "Endesa", nombre: "Permanencia 12 meses", kwh: 0.108, pot_punta: 0.122, pot_valle: 0.052, descuento: 28 },
        { empresa: "Iberdrola", nombre: "Sin permanencia", kwh: 0.112, pot_punta: 0.124, pot_valle: 0.054, descuento: 22 },
        { empresa: "Eleia", nombre: "Permanencia 12 meses", kwh: 0.115, pot_punta: 0.130, pot_valle: 0.045, descuento: 35 },
        { empresa: "Plenitude", nombre: "Sin permanencia", kwh: 0.104, pot_punta: 0.118, pot_valle: 0.050, descuento: 20 }
    ];

    let consumoGlobal = 350;
    let potenciaGlobal = 5.75;
    let gastoActualGlobal = 85;
    let alquilerGlobal = 0.81;

    // --- FUNCIÓN DE UTILIDAD PARA LEER LA URL ---
    function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // --- CÓDIGO DE INICIO (Comprueba el email) ---
    document.addEventListener('DOMContentLoaded', () => {
        const email = getParameterByName('email');
        const emailInput = document.getElementById('email');

        if (email) {
            emailInput.value = email;
            emailInput.readOnly = true; 
            emailInput.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
        } else {
            // Si llegan sin email, los devolvemos al formulario inicial (lead.html)
            window.location.href = 'lead.html'; 
        }
    });

    // --- 1. PROCESAR PDF (Intento de conexión a Python / Falla en web pública) ---
    async function procesar() {
        const email = document.getElementById("email").value.trim();
        const file = document.getElementById("factura").files[0];
        const estado = document.getElementById("estado");
        const manual = document.getElementById("manual");

        if (!email) { estado.textContent = "Falta el email"; return; }

        if (file) {
            estado.textContent = "Leyendo factura...";
            try {
                // Tesseract.js (para OCR de la factura)
                const { data: { text } } = await Tesseract.recognize(file, 'spa', { logger: m => m });
                const t = text.toLowerCase().replace(/[^0-9.,\s]/g, ' ').replace(/,/g, '.');

                // Lógica de extracción (manteniendo tu lógica original)
                const c = t.match(/(\d{3,5})\s*kwh/i);
                if (c) consumoGlobal = parseInt(c[1]);

                const p = t.match(/(\d+[.,]?\d*)\s*kw/i);
                if (p) potenciaGlobal = parseFloat(p[1].replace(',', '.'));

                const g = t.match(/(\d{2,4}[.,]\d{2})\s*€/i);
                if (g) gastoActualGlobal = parseFloat(g[1].replace(',', '.'));

                estado.textContent = `Leído: ${consumoGlobal} kWh · ${potenciaGlobal} kW · ${gastoActualGlobal.toFixed(2)}€`;
                manual.style.display = "none";
                
                // Intento de conexión al servidor Python (Solo funcionará en tu PC)
                try {
                    const formData = new FormData();
                    formData.append('email', email);
                    formData.append('factura', file);
                    
                    const response = await fetch(PYTHON_BACKEND_URL, { method: 'POST', body: formData });
                    const data = await response.json();
                    
                    if (data.status === 'success') { 
                        estado.textContent = "✅ Comparativa finalizada.";
                        mostrarResultados(data.consumo, data.potencia, data.gastoActual, data.tarifas); 
                        return; 
                    }
                } catch (e) {
                     // El servidor Python está apagado o inaccesible (Fallará en GitHub Pages)
                    estado.textContent = "⚠️ Error de conexión/cálculo. Usando datos extraídos para calcular manualmente.";
                    calcularFinal(); // Usamos los datos extraídos con la lógica manual
                    return;
                }

            } catch (e) {
                // Si falla Tesseract
                estado.textContent = "No se pudo leer → usa modo manual";
                manual.style.display = "block";
            }
        } else {
            manual.style.display = "block";
            estado.textContent = "Rellena los datos manualmente";
            return;
        }
        
        // Guardar email en Google Sheets (redundante si se hizo en lead.html, pero seguro)
        fetch(GOOGLE_SCRIPT_URL + "?email=" + encodeURIComponent(email));
    }
    
    // --- 2. CALCULAR MANUALMENTE ---
    function calcularManual() {
        consumoGlobal = parseFloat(document.getElementById("consumo").value) || 350;
        potenciaGlobal = parseFloat(document.getElementById("potencia").value) || 5.75;
        gastoActualGlobal = parseFloat(document.getElementById("gasto").value) || 85;
        
        if (isNaN(consumoGlobal) || isNaN(potenciaGlobal) || isNaN(gastoActualGlobal)) {
            document.getElementById("estado").textContent = "Rellena los 3 campos de datos manuales.";
            return;
        }
        
        document.getElementById("manual").style.display = "none";
        document.getElementById("estado").textContent = "✅ Calculando con datos manuales.";

        calcularFinal();
    }

    // --- 3. FUNCIÓN FINAL DE CÁLCULO Y RENDERIZADO ---
    function calcularFinal() {
        const resultado = document.getElementById("resultado");
        const dias = 30; // Usaremos 30 días para la estimación
        let html = '<h2 style="grid-column:1/-1;text-align:center;color:#a5f3fc;margin:30px 0">¡Tus mejores ofertas!</h2>';

        tarifas.forEach(t => {
            // CÁLCULOS ESTANDARIZADOS 
            const energia = consumoGlobal * t.kwh;
            const potenciaCoste = (potenciaGlobal * t.pot_punta * dias) + (potenciaGlobal * t.pot_valle * dias);
            const base = energia + potenciaCoste;
            const impuesto = base * 0.05113; // Impuesto de electricidad
            const baseIVA = base + impuesto + alquilerGlobal; // + Alquiler de contador
            const iva = baseIVA * 0.21;
            const totalSinDesc = baseIVA + iva;
            
            // Aplicar descuento
            const totalConDesc = totalSinDesc * (1 - t.descuento / 100);
            
            // Cálculo de ahorro
            const ahorroMensual = gastoActualGlobal - totalConDesc;
            const ahorroAnual = Math.round(ahorroMensual * 12);
            
            const claseAhorro = ahorroAnual > 0 ? 'positivo' : 'negativo';
            const simboloAhorro = ahorroAnual > 0 ? '¡Ahorras' : '¡Gastas más';
            const textoAhorro = `${simboloAhorro} ${Math.abs(ahorroAnual)}€ al año!`;

            html += `
                <div class="tarifa">
                    <div class="empresa">${t.empresa}</div>
                    <div style="color:#94a3b8;margin:8px 0">${t.nombre}</div>
                    <div class="precio">${totalConDesc.toFixed(0)}€/mes</div>
                    <div class="ahorro ${claseAhorro}">${textoAhorro}</div>
                    <div style="margin-top:10px;color:#94a3b8;font-size:0.9rem">-${t.descuento}% primer año</div>
                </div>
            `;
        });

        resultado.innerHTML = html;
        resultado.style.display = "grid";
    }
</script>
</body>
</html>
